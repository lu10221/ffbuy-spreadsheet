<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3P748DL5L0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-3P748DL5L0');

        // ğŸ”½ è‡ªåŠ¨è·å–å¹¶ä¸ŠæŠ¥ utm_content å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const utmContent = urlParams.get('utm_content');
        if (utmContent) {
            gtag('event', 'utm_content_event', {
                utm_content: utmContent
            });
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$FFBuy SpreadSheet</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="global-search.css">    
    <link rel="stylesheet" href="product-detail-modal.css">
    
    <!-- ğŸ”¥ æ ¸å¿ƒé…ç½®æ–‡ä»¶ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="config.js"></script>
    
    <!-- å…¶ä»–åŠŸèƒ½æ¨¡å— -->
    <script src="product-service.js"></script>
    <script src="product-renderer.js"></script>
    <script src="trust-info.js"></script>
    <script src="product-trust-info.js"></script>
    <script src="product-detail.js"></script>
    <script src="global-search.js"></script>
</head>
<body>
    <!-- ğŸ”¥ ä¿¡ä»»ä¿¡æ¯æ  -->
    <div class="top-info-bar" id="trust-bar"> 
        <i class="fas fa-shield-alt"></i> 
        This page displays products only. Orders are securely processed via <strong style="color:#2476db; font-weight:600;">CNFANS Platform</strong> with buyer protection & after-sales support.
    </div>
    

    
    <header>
        <div class="header-top">
            <a href="#" class="logo" onclick="SPA.navigateToCategory(CONFIG.SITE.DEFAULT_CATEGORY)">$FFBuy SpreadSheet</a>
            <div class="nav-links" id="header-nav">
                <!-- å¯¼èˆªå°†ç”±SPAåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="header-bottom">
            <div class="search-container">
                <input type="text" class="search-box" placeholder="Search products...">
                <span class="search-icon"><i class="fas fa-search"></i></span>
            </div>
        </div>
    </header>

    <!-- ğŸ”¥ æ”¯ä»˜æ–¹å¼ä¿¡æ¯ -->
    <div id="payment-methods" style="text-align: center; margin: 12px 0 18px;">
        <div style="font-size: 13px; color: #555; margin-bottom: 6px;"><strong>Secure payments</strong> supported by</div>
        <div style="display: inline-flex; align-items: center; gap: 12px;" id="payment-icons">
            <!-- æ”¯ä»˜å›¾æ ‡å°†ç”±SPAåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ğŸ”¥ ä¸»å¯¼èˆª -->
    <nav id="main-nav">
        <!-- å¯¼èˆªå°†ç”±SPAåŠ¨æ€ç”Ÿæˆ -->
    </nav>

    <!-- ğŸ”¥ ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="container">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading-indicator" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #666;"></i>
            <p style="margin-top: 10px; color: #666;">Loading products...</p>
        </div>
        
        <!-- é”™è¯¯çŠ¶æ€ -->
        <div id="error-indicator" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #e74c3c;"></i>
            <p style="margin-top: 10px; color: #e74c3c;" id="error-message">Failed to load products</p>
            <button onclick="SPA.retryLoadCategory()" style="margin-top: 15px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
        </div>
        
        <!-- äº§å“ç½‘æ ¼ -->
         <div class="products-grid" id="products-container">
             <!-- Products will be loaded dynamically -->
         </div>
    </div>

    <!-- ğŸ”¥ æµ®åŠ¨æŒ‰é’® -->
    <div class="floating-buttons" id="floatingButtons">
        <div class="float-btn toggle-btn" id="toggleFloatingBtn"><i class="fas fa-headset"></i></div>
        <div class="floating-content" id="floatingContent">
            <img src="img/query.png" alt="Trust Guarantee" class="trust-icon" id="trustBtn">
            <img src="img/telegram.png" alt="Telegram" class="telegram-icon">
            <img src="img/ws.png" alt="WhatsApp" class="whatsapp-icon">
        </div>
    </div>
    <div class="float-btn back-to-top"><i class="fas fa-arrow-up"></i></div>

    <!-- ğŸ”¥ å•†å“è¯¦æƒ…å¼¹çª— -->
    <div class="product-detail-modal" id="productDetailModal">
        <div class="product-detail-content">
            <div class="product-detail-header">
                <h2 class="product-detail-title">Product Details</h2>
                <button class="product-detail-close" id="closeDetailModal">&times;</button>
            </div>
            <div class="product-detail-body" id="productDetailBody">
                <div class="product-detail-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading product details...
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ”¥ SPAæ ¸å¿ƒè„šæœ¬ -->
    <script>
        // SPAåº”ç”¨æ ¸å¿ƒ
         const SPA = {
             currentCategory: null,
             isLoading: false,
            
            // åˆå§‹åŒ–åº”ç”¨
            init() {
                this.generateNavigation();
                this.generatePaymentMethods();
                this.setupEventListeners();
                this.handleInitialRoute();
            },
            
            // å¤„ç†åˆå§‹è·¯ç”±
            handleInitialRoute() {
                const urlParams = new URLSearchParams(window.location.search);
                const category = urlParams.get('category') || CONFIG.SITE.DEFAULT_CATEGORY;
                this.navigateToCategory(category, false);
            },
            
            // ç”Ÿæˆå¯¼èˆªèœå•
            generateNavigation() {
                const headerNav = document.getElementById('header-nav');
                const mainNav = document.getElementById('main-nav');
                
                const navHTML = CONFIG.categories.map(category => {
                    return `<a href="#" onclick="SPA.navigateToCategory('${category.name}')" data-category="${category.name}">
                        <i class="${category.icon}"></i> ${category.displayName}
                    </a>`;
                }).join('\n');
                
                if (headerNav) headerNav.innerHTML = navHTML;
                if (mainNav) mainNav.innerHTML = navHTML;
            },
            
            // ç”Ÿæˆæ”¯ä»˜æ–¹å¼
            generatePaymentMethods() {
                const paymentIcons = document.getElementById('payment-icons');
                if (paymentIcons && CONFIG.PAYMENT_METHODS) {
                    paymentIcons.innerHTML = CONFIG.PAYMENT_METHODS.map(method => 
                        `<img src="${method.logo}" alt="${method.alt}" height="24" style="padding: 0 4px; vertical-align: middle;">`
                    ).join('\n');
                }
            },
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
             setupEventListeners() {
                 // æµè§ˆå™¨å‰è¿›åé€€
                 window.addEventListener('popstate', (event) => {
                     if (event.state && event.state.category) {
                         this.navigateToCategory(event.state.category, false);
                     } else {
                         this.handleInitialRoute();
                     }
                 });
             },
            
            // å¯¼èˆªåˆ°åˆ†ç±»
            navigateToCategory(categoryName, updateHistory = true) {
                if (this.isLoading) {
                    // å–æ¶ˆå½“å‰åŠ è½½ï¼Œå…è®¸å¿«é€Ÿåˆ‡æ¢åˆ†ç±»
                    if (typeof productRenderer !== 'undefined' && typeof productRenderer.cancelLoad === 'function') {
                        productRenderer.cancelLoad();
                    }
                }
                
                const category = CONFIG.UTILS.getCategoryByName(categoryName);
                if (!category) {
                    console.error('Category not found:', categoryName);
                    return;
                }
                
                if (updateHistory && typeof gtag === 'function') {
                    gtag('event', 'category_click', { category_name: category.name, category_display: category.displayName });
                }

                this.currentCategory = categoryName;
                
                // æ›´æ–°URLå’Œå†å²è®°å½•
                if (updateHistory) {
                    const newUrl = `${window.location.pathname}?category=${encodeURIComponent(categoryName)}`;
                    history.pushState({ category: categoryName }, '', newUrl);
                }
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.title = `${category.displayName} - ${CONFIG.SITE.NAME}`;
                
                // æ›´æ–°å¯¼èˆªçŠ¶æ€
                this.updateNavigationState(categoryName);

                // æ¸…ç†ä»»ä½•ä¿ç•™çš„â€œè¿”å›å½“å‰åˆ†ç±»â€æŒ‰é’®
                const backBtn = document.getElementById('back-to-results-btn');
                if (backBtn) backBtn.remove();
                
                // åŠ è½½äº§å“
                this.loadCategoryProducts(category);
            },
            
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            updateNavigationState(activeCategory) {
                document.querySelectorAll('nav a, .nav-links a').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.category === activeCategory) {
                        link.classList.add('active');
                    }
                });
            },
            
            // åŠ è½½åˆ†ç±»äº§å“
             async loadCategoryProducts(category) {
                 this.showLoading();
                 
                 try {
                     // ä½¿ç”¨ç°æœ‰çš„productRendereræ¥åŠ è½½å’Œæ¸²æŸ“äº§å“
                     if (!productRenderer.init('products-container')) {
                         throw new Error('Failed to initialize product renderer');
                     }
                     
                     await productRenderer.loadProducts(category.endpoint);
                     this.hideLoading();
                     
                 } catch (error) {
                     console.error('Error loading products:', error);
                     this.showError('Failed to load products. Please try again.');
                 }
             },
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading() {
                this.isLoading = true;
                document.getElementById('loading-indicator').style.display = 'block';
                document.getElementById('error-indicator').style.display = 'none';
                document.getElementById('products-container').style.display = 'none';
            },
            
            // éšè—åŠ è½½çŠ¶æ€
            hideLoading() {
                this.isLoading = false;
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('products-container').style.display = 'grid';
            },
            
            // æ˜¾ç¤ºé”™è¯¯
            showError(message) {
                this.isLoading = false;
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('products-container').style.display = 'none';
                document.getElementById('error-indicator').style.display = 'block';
                document.getElementById('error-message').textContent = message;
            },
            
            // é‡è¯•åŠ è½½
            retryLoadCategory() {
                if (this.currentCategory) {
                    const category = CONFIG.UTILS.getCategoryByName(this.currentCategory);
                    if (category) {
                        this.loadCategoryProducts(category);
                    }
                }
            }
        };
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–SPA
        document.addEventListener('DOMContentLoaded', () => {
            SPA.init();
        });
        
        // å…¨å±€æš´éœ²SPAå¯¹è±¡
         window.SPA = SPA;
     </script>
     
     <!-- ğŸ”¥ æµ®åŠ¨æŒ‰é’®è„šæœ¬ -->
     <script src="floating-buttons.js"></script>
</body>
</html>


