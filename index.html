<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DZ3110PTYG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-DZ3110PTYG');

        // üîΩ Ëá™Âä®Ëé∑ÂèñÂπ∂‰∏äÊä• utm_content ÂèÇÊï∞
        const urlParams = new URLSearchParams(window.location.search);
        const utmContent = urlParams.get('utm_content');
        if (utmContent) {
            gtag('event', 'utm_content_event', {
                utm_content: utmContent
            });
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$FFBuy SpreadSheet</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="global-search.css">    
    <link rel="stylesheet" href="product-detail-modal.css">
    
    <!-- üî• Ê†∏ÂøÉÈÖçÁΩÆÊñá‰ª∂ - ÂøÖÈ°ªÊúÄÂÖàÂä†ËΩΩ -->
    <script src="config.js"></script>
    
    <!-- ÂÖ∂‰ªñÂäüËÉΩÊ®°Âùó -->
    <script src="product-service.js"></script>
    <script src="product-renderer.js"></script>
    <script src="trust-info.js"></script>
    <script src="product-trust-info.js"></script>
    <script src="product-detail.js"></script>
    <script src="global-search.js"></script>
</head>
<body>
    <!-- üî• ‰ø°‰ªª‰ø°ÊÅØÊ†è -->
    <div class="top-info-bar" id="trust-bar"> 
        <i class="fas fa-shield-alt"></i> 
        This page displays products only. Orders are securely processed via <strong style="color:#2476db; font-weight:600;">CNFANS Platform</strong> with buyer protection & after-sales support.
    </div>
    

    
    <header>
        <div class="header-top">
            <a href="#" class="logo" onclick="SPA.navigateToCategory(CONFIG.SITE.DEFAULT_CATEGORY)">$FFBuy SpreadSheet</a>
            <div class="nav-links" id="header-nav">
                <!-- ÂØºËà™Â∞ÜÁî±SPAÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
        <div class="header-bottom">
            <div class="search-container">
                <input type="text" class="search-box" placeholder="Search products...">
                <span class="search-icon"><i class="fas fa-search"></i></span>
            </div>
        </div>
    </header>

    <!-- üî• ÊîØ‰ªòÊñπÂºè‰ø°ÊÅØ -->
    <div id="payment-methods" style="text-align: center; margin: 12px 0 18px;">
        <div style="font-size: 13px; color: #555; margin-bottom: 6px;"><strong>Secure payments</strong> supported by</div>
        <div style="display: inline-flex; align-items: center; gap: 12px;" id="payment-icons">
            <!-- ÊîØ‰ªòÂõæÊ†áÂ∞ÜÁî±SPAÂä®ÊÄÅÁîüÊàê -->
        </div>
    </div>

    <!-- üî• ‰∏ªÂØºËà™ -->
    <nav id="main-nav">
        <!-- ÂØºËà™Â∞ÜÁî±SPAÂä®ÊÄÅÁîüÊàê -->
    </nav>

    <!-- üî• ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
    <div class="container">
        <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
        <div id="loading-indicator" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #666;"></i>
            <p style="margin-top: 10px; color: #666;">Loading products...</p>
        </div>
        
        <!-- ÈîôËØØÁä∂ÊÄÅ -->
        <div id="error-indicator" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #e74c3c;"></i>
            <p style="margin-top: 10px; color: #e74c3c;" id="error-message">Failed to load products</p>
            <button onclick="SPA.retryLoadCategory()" style="margin-top: 15px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
        </div>
        
        <!-- ‰∫ßÂìÅÁΩëÊ†º -->
         <div class="products-grid" id="products-container">
             <!-- Products will be loaded dynamically -->
         </div>
    </div>

    <!-- üî• ÊµÆÂä®ÊåâÈíÆ -->
    <div class="floating-buttons" id="floatingButtons">
        <div class="float-btn toggle-btn" id="toggleFloatingBtn"><i class="fas fa-headset"></i></div>
        <div class="floating-content" id="floatingContent">
            <img src="img/query.png" alt="Trust Guarantee" class="trust-icon" id="trustBtn">
            <img src="img/telegram.png" alt="Telegram" class="telegram-icon">
            <img src="img/ws.png" alt="WhatsApp" class="whatsapp-icon">
        </div>
    </div>
    <div class="float-btn back-to-top"><i class="fas fa-arrow-up"></i></div>

    <!-- üî• ÂïÜÂìÅËØ¶ÊÉÖÂºπÁ™ó -->
    <div class="product-detail-modal" id="productDetailModal">
        <div class="product-detail-content">
            <div class="product-detail-header">
                <h2 class="product-detail-title">Product Details</h2>
                <button class="product-detail-close" id="closeDetailModal">&times;</button>
            </div>
            <div class="product-detail-body" id="productDetailBody">
                <div class="product-detail-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading product details...
                </div>
            </div>
        </div>
    </div>

    <!-- üî• SPAÊ†∏ÂøÉËÑöÊú¨ -->
    <script>
        // SPAÂ∫îÁî®Ê†∏ÂøÉ
         const SPA = {
             currentCategory: null,
             isLoading: false,
            
            // ÂàùÂßãÂåñÂ∫îÁî®
            init() {
                this.generateNavigation();
                this.generatePaymentMethods();
                this.setupEventListeners();
                this.handleInitialRoute();
            },
            
            // Â§ÑÁêÜÂàùÂßãË∑ØÁî±
            handleInitialRoute() {
                const urlParams = new URLSearchParams(window.location.search);
                const category = urlParams.get('category') || CONFIG.SITE.DEFAULT_CATEGORY;
                this.navigateToCategory(category, false);
            },
            
            // ÁîüÊàêÂØºËà™ËèúÂçï
            generateNavigation() {
                const headerNav = document.getElementById('header-nav');
                const mainNav = document.getElementById('main-nav');
                
                const navHTML = CONFIG.categories.map(category => {
                    return `<a href="#" onclick="SPA.navigateToCategory('${category.name}')" data-category="${category.name}">
                        <i class="${category.icon}"></i> ${category.displayName}
                    </a>`;
                }).join('\n');
                
                if (headerNav) headerNav.innerHTML = navHTML;
                if (mainNav) mainNav.innerHTML = navHTML;
            },
            
            // ÁîüÊàêÊîØ‰ªòÊñπÂºè
            generatePaymentMethods() {
                const paymentIcons = document.getElementById('payment-icons');
                if (paymentIcons && CONFIG.PAYMENT_METHODS) {
                    paymentIcons.innerHTML = CONFIG.PAYMENT_METHODS.map(method => 
                        `<img src="${method.logo}" alt="${method.alt}" height="24" style="padding: 0 4px; vertical-align: middle;">`
                    ).join('\n');
                }
            },
            
            // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
             setupEventListeners() {
                 // ÊµèËßàÂô®ÂâçËøõÂêéÈÄÄ
                 window.addEventListener('popstate', (event) => {
                     if (event.state && event.state.category) {
                         this.navigateToCategory(event.state.category, false);
                     } else {
                         this.handleInitialRoute();
                     }
                 });
             },
            
            // ÂØºËà™Âà∞ÂàÜÁ±ª
            navigateToCategory(categoryName, updateHistory = true) {
                if (this.isLoading) {
                    // ÂèñÊ∂àÂΩìÂâçÂä†ËΩΩÔºåÂÖÅËÆ∏Âø´ÈÄüÂàáÊç¢ÂàÜÁ±ª
                    if (typeof productRenderer !== 'undefined' && typeof productRenderer.cancelLoad === 'function') {
                        productRenderer.cancelLoad();
                    }
                }
                
                const category = CONFIG.UTILS.getCategoryByName(categoryName);
                if (!category) {
                    console.error('Category not found:', categoryName);
                    return;
                }
                
                if (updateHistory && typeof window.gtag === 'function') {
                    window.gtag('event', 'category_click', { category_name: category.name, category_display: category.displayName });
                }

                this.currentCategory = categoryName;
                
                // Êõ¥Êñ∞URLÂíåÂéÜÂè≤ËÆ∞ÂΩï
                if (updateHistory) {
                    const newUrl = `${window.location.pathname}?category=${encodeURIComponent(categoryName)}`;
                    history.pushState({ category: categoryName }, '', newUrl);
                    if (typeof window.gtag === 'function') {
                        var pv = { page_title: `${category.displayName} - ${CONFIG.SITE.NAME}`, page_path: newUrl, page_location: window.location.origin + newUrl };
                        var u = new URLSearchParams(window.location.search);
                        if (u.get('ga_debug') === '1') { pv.debug_mode = true; }
                        window.gtag('event', 'page_view', pv);
                    }
                }
                
                // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
                document.title = `${category.displayName} - ${CONFIG.SITE.NAME}`;
                
                // Êõ¥Êñ∞ÂØºËà™Áä∂ÊÄÅ
                this.updateNavigationState(categoryName);

                // Ê∏ÖÁêÜ‰ªª‰Ωï‰øùÁïôÁöÑ‚ÄúËøîÂõûÂΩìÂâçÂàÜÁ±ª‚ÄùÊåâÈíÆ
                const backBtn = document.getElementById('back-to-results-btn');
                if (backBtn) backBtn.remove();
                
                // Âä†ËΩΩ‰∫ßÂìÅ
                this.loadCategoryProducts(category);
            },
            
            // Êõ¥Êñ∞ÂØºËà™Áä∂ÊÄÅ
            updateNavigationState(activeCategory) {
                document.querySelectorAll('nav a, .nav-links a').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.category === activeCategory) {
                        link.classList.add('active');
                    }
                });
            },
            
            // Âä†ËΩΩÂàÜÁ±ª‰∫ßÂìÅ
             async loadCategoryProducts(category) {
                 this.showLoading();
                 
                 try {
                     // ‰ΩøÁî®Áé∞ÊúâÁöÑproductRendererÊù•Âä†ËΩΩÂíåÊ∏≤Êüì‰∫ßÂìÅ
                     if (!productRenderer.init('products-container')) {
                         throw new Error('Failed to initialize product renderer');
                     }
                     
                     await productRenderer.loadProducts(category.endpoint);
                     this.hideLoading();
                     
                 } catch (error) {
                     console.error('Error loading products:', error);
                     this.showError('Failed to load products. Please try again.');
                 }
             },
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            showLoading() {
                this.isLoading = true;
                document.getElementById('loading-indicator').style.display = 'block';
                document.getElementById('error-indicator').style.display = 'none';
                document.getElementById('products-container').style.display = 'none';
            },
            
            // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
            hideLoading() {
                this.isLoading = false;
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('products-container').style.display = 'grid';
            },
            
            // ÊòæÁ§∫ÈîôËØØ
            showError(message) {
                this.isLoading = false;
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('products-container').style.display = 'none';
                document.getElementById('error-indicator').style.display = 'block';
                document.getElementById('error-message').textContent = message;
            },
            
            // ÈáçËØïÂä†ËΩΩ
            retryLoadCategory() {
                if (this.currentCategory) {
                    const category = CONFIG.UTILS.getCategoryByName(this.currentCategory);
                    if (category) {
                        this.loadCategoryProducts(category);
                    }
                }
            }
        };
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñSPA
        document.addEventListener('DOMContentLoaded', () => {
            SPA.init();
        });
        
        // ÂÖ®Â±ÄÊö¥Èú≤SPAÂØπË±°
         window.SPA = SPA;
     </script>
     
     <!-- üî• ÊµÆÂä®ÊåâÈíÆËÑöÊú¨ -->
     <script src="floating-buttons.js"></script>
</body>
</html>


